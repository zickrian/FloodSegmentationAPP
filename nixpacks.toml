# Nixpacks configuration for Railway
# Hybrid Deployment: Next.js + FastAPI

[phases.setup]
# Install BOTH Node.js and Python + System Libs
nixPkgs = ["nodejs_20", "python311", "gcc", "ffmpeg", "libgl1", "glib"]
aptPkgs = ["libgl1-mesa-glx", "libglib2.0-0"]

[phases.install]
# Install Python & Node dependencies
cmds = [
    "python -m pip install --upgrade pip",
    "python -m pip install --no-cache-dir -r backend/requirements.txt",
    "npm ci"
]

[phases.build]
# Build Next.js application
cmds = [
    "npm run build"
]

[start]
# Run both using the start script
cmd = "chmod +x start.sh && ./start.sh"

[variables]
NIXPACKS_PYTHON_VERSION = "3.11"
PYTHONUNBUFFERED = "1"
OPENCV_HEADLESS = "1"
# Ensure Next.js connects to local backend internally
NEXT_PUBLIC_API_URL = "/api"
