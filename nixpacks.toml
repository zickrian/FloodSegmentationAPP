# Nixpacks configuration for Railway - BACKEND ONLY
# This config is for deploying only the FastAPI backend (no Node.js/Next.js)

[phases.setup]
# Install Python only (no Node.js needed for backend only)
nixPkgs = ["python311", "python311Packages.pip", "gcc"]
# Required system libraries for OpenCV and other dependencies
aptPkgs = ["libgl1", "libglx-mesa0", "libglib2.0-0"]

[phases.install]
# Install Python dependencies only
cmds = [
    # Use a dedicated virtualenv to avoid immutable Nix system python
    "python -m venv /app/.venv",
    "/app/.venv/bin/pip install --upgrade pip setuptools wheel",
    # Install with no-cache-dir to reduce image size
    "/app/.venv/bin/pip install --no-cache-dir -r backend/requirements.txt",
    # Aggressive cleanup after pip install
    "rm -rf /root/.cache/pip",
    "rm -rf /tmp/*",
    # Remove Python bytecode files
    "find /app/.venv -type f -name '*.pyc' -delete 2>/dev/null || true",
    "find /app/.venv -type f -name '*.pyo' -delete 2>/dev/null || true",
    "find /app/.venv -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true"
]

[phases.build]
# No build phase needed for backend only (no Next.js to build)
cmds = [
    # Remove test files and docs from venv
    "find /app/.venv -type d \\( -name 'tests' -o -name 'test' \\) -exec rm -rf {} + 2>/dev/null || true",
    "find /app/.venv -type f \\( -name '*.md' -o -name 'LICENSE*' -o -name 'CHANGELOG*' \\) -exec rm -f {} + 2>/dev/null || true",
    # Remove static libraries (*.a files) - not needed at runtime
    "find /app/.venv -type f -name '*.a' -delete 2>/dev/null || true"
]

[start]
# Run backend only using the start script
cmd = "chmod +x start.sh && ./start.sh"

[variables]
PYTHONUNBUFFERED = "1"
OPENCV_HEADLESS = "1"
# CORS Origins - will be set via Railway environment variables
CORS_ORIGINS = "*"
