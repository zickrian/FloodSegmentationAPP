# Nixpacks configuration for Railway
# Hybrid Deployment: Next.js + FastAPI

[phases.setup]
# Install BOTH Node.js and Python
# Removed ffmpeg as it's not used - saves ~100MB
nixPkgs = ["nodejs_20", "python311", "python311Packages.pip", "gcc"]
# Required system libraries for OpenCV and other dependencies
aptPkgs = ["libgl1", "libglx-mesa0", "libglib2.0-0"]

[phases.install]
# Install Python & Node dependencies
cmds = [
    # Use a dedicated virtualenv to avoid immutable Nix system python
    "python -m venv /app/.venv",
    "/app/.venv/bin/pip install --upgrade pip setuptools wheel",
    # Install with no-cache-dir to reduce image size
    "/app/.venv/bin/pip install --no-cache-dir -r backend/requirements.txt",
    # Install all dependencies for build (including dev dependencies)
    "npm ci",
    # Install Railway CLI globally for bucket access
    "npm install -g @railway/cli",
    # Aggressive cleanup after pip install
    "rm -rf /root/.cache/pip",
    "rm -rf /tmp/*",
    # Remove Python bytecode files - use -delete for more reliable cleanup
    "find /app/.venv -type f -name '*.pyc' -delete 2>/dev/null || true",
    "find /app/.venv -type f -name '*.pyo' -delete 2>/dev/null || true",
    "find /app/.venv -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true"
]

[phases.build]
# Build Next.js application
cmds = [
    "npm run build",
    # Clean up unnecessary files after build to reduce image size
    "rm -rf node_modules/.cache",
    "rm -rf .next/cache/webpack",
    # Remove dev dependencies after build (keep only production dependencies)
    "npm prune --production",
    # Remove test files and docs from node_modules - use -exec for reliability
    "find node_modules -type d \\( -name 'test' -o -name 'tests' -o -name '__tests__' \\) -exec rm -rf {} + 2>/dev/null || true",
    "find node_modules -type f \\( -name '*.md' -o -name 'LICENSE*' -o -name 'CHANGELOG*' \\) -exec rm -f {} + 2>/dev/null || true",
    # Remove Python test files and docs from venv - use -exec for reliability
    "find /app/.venv -type d \\( -name 'tests' -o -name 'test' \\) -exec rm -rf {} + 2>/dev/null || true",
    "find /app/.venv -type f \\( -name '*.md' -o -name 'LICENSE*' -o -name 'CHANGELOG*' \\) -exec rm -f {} + 2>/dev/null || true",
    # Remove static libraries (*.a files) - not needed at runtime, can save 100s of MB
    "find /app/.venv -type f -name '*.a' -delete 2>/dev/null || true"
]

[start]
# Run both using the start script
cmd = "chmod +x start.sh && ./start.sh"

[variables]
PYTHONUNBUFFERED = "1"
OPENCV_HEADLESS = "1"
# Empty - Next.js rewrites handle internal routing
NEXT_PUBLIC_API_URL = ""
