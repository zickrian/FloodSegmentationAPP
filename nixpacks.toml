# Nixpacks configuration for Railway
# Hybrid Deployment: Next.js + FastAPI

[phases.setup]
# Install BOTH Node.js and Python
nixPkgs = ["nodejs_20", "python311", "python311Packages.pip", "gcc", "ffmpeg"]
# Required system libraries for OpenCV and other dependencies
aptPkgs = ["libgl1", "libglx-mesa0", "libglib2.0-0"]

[phases.install]
# Install Python & Node dependencies
cmds = [
    "pip install --upgrade pip setuptools wheel",
    "pip install --no-cache-dir -r backend/requirements.txt",
    "npm ci"
]

[phases.build]
# Build Next.js application
cmds = [
    "npm run build"
]

[start]
# Run both using the start script
cmd = "chmod +x start.sh && ./start.sh"

[variables]
PYTHONUNBUFFERED = "1"
OPENCV_HEADLESS = "1"
# Empty - Next.js rewrites handle internal routing
NEXT_PUBLIC_API_URL = ""
