# Nixpacks configuration for Railway - BACKEND ONLY

[phases.setup]
# OpenCV dependencies: libGL for OpenGL, glib for libgthread
# Adding full system library support to prevent any "missing shared object" errors
nixPkgs = ["python311", "python311Packages.pip", "gcc", "curl", "awscli2", "libGL", "glib", "xorg.libXext", "xorg.libXrender", "xorg.libSM"]

[phases.install]
cmds = [
    "python -m venv /app/.venv",
    "/app/.venv/bin/pip install --upgrade pip setuptools wheel",
    # Step 1: Install all requirements (Albumentations may pull opencv-python)
    "/app/.venv/bin/pip install --no-cache-dir -r backend/requirements.txt",
    # Step 2: NUCLEAR - Remove ALL opencv packages completely
    "/app/.venv/bin/pip uninstall -y opencv-python opencv-python-headless opencv-contrib-python opencv-contrib-python-headless 2>/dev/null || true",
    # Step 3: Reinstall ONLY the headless version (clean slate)
    "/app/.venv/bin/pip install --no-cache-dir opencv-python-headless==4.9.0.80",
    # Cleanup
    "rm -rf /root/.cache/pip /tmp/*"
]

[phases.build]
# No extra build steps needed for headless mode
cmds = []

[start]
cmd = "chmod +x start.sh && ./start.sh"

[variables]
PYTHONUNBUFFERED = "1"
OPENCV_HEADLESS = "1"
CORS_ORIGINS = "*"
