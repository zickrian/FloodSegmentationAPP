# Nixpacks configuration for Railway - BACKEND ONLY
# This config is for deploying only the FastAPI backend (no Node.js/Next.js)

[phases.setup]
# Install Python only (no Node.js needed for backend only)
nixPkgs = ["python311", "python311Packages.pip", "gcc", "curl", "awscli2"]
# Required system libraries for OpenCV and other dependencies
aptPkgs = ["libgl1", "libglib2.0-0"]

[phases.install]
# Install Python dependencies directly to user site-packages (no virtualenv)
# This avoids vdso_gettimeofday errors that occur with virtualenv in Nix environment
cmds = [
    # Upgrade pip
    "pip install --upgrade pip setuptools wheel",
    # Uninstall any regular opencv-python if accidentally installed
    "pip uninstall -y opencv-python opencv-contrib-python 2>/dev/null || true",
    # Install dependencies to user site-packages
    "pip install --no-cache-dir -r backend/requirements.txt",
    # Cleanup
    "rm -rf /root/.cache/pip /tmp/*"
]

[phases.build]
# No build phase needed for backend only
cmds = []

[start]
# Run backend using start script
cmd = "chmod +x start.sh && ./start.sh"

[variables]
PYTHONUNBUFFERED = "1"
OPENCV_HEADLESS = "1"
CORS_ORIGINS = "*"
